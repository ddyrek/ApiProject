@page "/customers/add"

@using Blazored.FluentValidation
@using Groomer.Shared.Customers.Commands
@using Groomer.Client.Components.Customers.EditComponents
@using Groomer.Client.Shared.Components.CustomInputs

<EditForm Model="@NewCustomer" OnSubmit="OnSubmitMethod">
    <FluentValidationValidator />
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Customer Add</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/customers">Customers</a></li>
                        <li class="breadcrumb-item active">Add</li>
                    </ol>
                </div>
            </div>
        </div><!-- /.container-fluid -->
    </section>

<!-- Main content -->
    <section class="content">
        <div class="row">
            <div class="col-md-6">
                <CustomerAddGeneral EditMode="@EditMode" NewCustomer="@NewCustomer"/>
            </div>
            <div class="col-md-6">
                <div class="card card-secondary">
                    <div class="card-header">
                        <h3 class="card-title">Dogs</h3>

                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <label for="title">Dog name</label>
                        <InputSelect disabled="@EditMode" id="Name" @bind-Value="NewCustomer.Dogs.Name" class="form-control">
                            <option value="" disabled>-----Select Value-----</option>
                            @foreach (var item in Dogs)
                            {
                                <option value="@item.Name">@item.Name</option>
                            }
                        </InputSelect>

                        <label for="files">Files</label>
                        <InputFile id="files" OnChange="OnChangeInputFile" multiple class="form-control"/>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <a href="#" class="btn btn-secondary">Cancel</a>
                <input type="button" value="Enter edit mode" class="btn btn-warning" @onclick="ToggleEditMode" />
                <input type="submit" value="Create new Customer" class="btn btn-success float-right">
            </div>
        </div>
    </section>
    <!-- /.content -->
    <ValidationSummary />
</EditForm>
@code {
    public AddCustomerVM NewCustomer { get; set; } = new();
    public List<DogVm> Dogs { get; set; } = new();// List<DogVm> bo Kolekcja w Domain/Entity na Kliencie
    public bool EditMode { get; set; } = false;
    private IReadOnlyList<IBrowserFile> files;

    protected override void OnInitialized()
    {
        NewCustomer.Dogs = new DogVm();

        Dogs.Add(new DogVm() { Id = 1, Name = "Jack" });
        Dogs.Add(new DogVm() { Id = 2, Name = "Coli" });
        Dogs.Add(new DogVm() { Id = 3, Name = "Max" });
    }

    private async Task OnSubmitMethod(EditContext editContext)
    {
        if (editContext.Validate())
        {
            foreach (var file in files)
            {
                Stream stream = file.OpenReadStream();
                MemoryStream ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                stream.Close();

                //Save your file

                Console.WriteLine($"File named: {file.Name} has size of {file.Size}");
                Console.WriteLine($"Stream has {ms.ToArray().Length} size");

                ms.Close();
            }
            Console.WriteLine("Post has been validated");
        }
        else
        {
            Console.WriteLine("Post has not been validated");

        }

    }

    private void OnDblClickMethod()
    {
        Console.WriteLine("Textbox has been double clicked!");
    }

    private void ToggleEditMode()
    {
        EditMode = !EditMode;
        StateHasChanged();
    }

    private void OnChangeInputFile(InputFileChangeEventArgs args)
    {
        files = args.GetMultipleFiles();
    }
}
